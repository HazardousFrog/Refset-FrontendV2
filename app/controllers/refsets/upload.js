import MembersAdapter 	from '../../adapters/simple-members';
var membersAdapter = MembersAdapter.create();

export default Ember.ArrayController.extend({
	
	needs : ["login"],
	
	model : [],
	
	importRequiredFilteredModel : function()
	{
		var concepts = this.get('model');
		
		Ember.Logger.log("importRequiredFilteredModel concepts");

		return concepts.filter(function(concept)
		{
			return !concept.meta.deleteConcept;
		});
	}.property('model'),
	
    importError : null,

	clearMemberList : function()
	{
		this.model.setObjects([]);
	},
	
	overrideImportList : function(newList)
	{
		this.model.setObjects(newList);
	},
	
	getConceptDataInProgress : false,

	clearMembers : function()
	{
		this.model.setObjects([]);
	},
	
	getMembersMarkedForImport : function()
	{
		var concepts = this.get('model');
		
		var conceptsToImport =  concepts.map(function(concept)
		{
			var validConcept = $.extend(true, {}, concept);
			
			delete validConcept["meta"];
			
			return concept.meta.deleteConcept ? null : validConcept;
		});
		
		conceptsToImport = $.grep(conceptsToImport,function(n){ return(n); });
		
		return conceptsToImport;
	},

	addConceptsToImportList : function(membersToAddToList)
	{
		var membersToImport = [];
		
		var membersToImportOriginal = this.get("model");

		membersToImportOriginal.map(function(member)
		{
			membersToImport.push(member);
		});
		
		membersToAddToList.map(function(member)
		{
			membersToImport.push(member);
		});
		
		this.model.setObjects(membersToImport);
	},

	showImportHelp : function()
	{
        BootstrapDialog.show({
            title: 'Member import help',
            closable: false,
            message: '...............',
            buttons: [{
                label: 'OK',
                action: function(dialog)
                {
                    dialog.close();
                }
            }]
        });		
	},
	
	toggleImportMember : function(referencedComponentId)
	{
		var members = $.extend(true, [], this.get("model"));
		
		for (var m=0;m<members.length;m++)
		{
			if (members[m].referencedComponentId === referencedComponentId)
			{
				members[m].meta.deleteConcept = !members[m].meta.deleteConcept;
				this.set("model",members);
				break;
			}
		}
	},

	toggleImportMemberActive : function(referencedComponentId)
	{
		var members = $.extend(true, [], this.get("model"));
		
		for (var m=0;m<members.length;m++)
		{
			if (members[m].referencedComponentId === referencedComponentId)
			{
				members[m].active = !members[m].active;
				this.set("model",members);
				break;
			}
		}
	},
	
    actions :
    {
    	importSingleMember : function(member)
    	{
    		Ember.Logger.log("controller.refstes.upload:actions:importSingleFile");
    		
    		member.moduleId = $('#newRefsetModuleId').val();
    		member.active 	= true;
    		
    		member.meta = 	{};
			member.meta.conceptActive 			= true;
			member.meta.deleteConcept 			= false;
			member.meta.found 					= true;
			member.meta.disabled				= false;
						
			this.addConceptsToImportList([member]);
    	},
    	
    	
		importFlatFile : function(members)
		{
    		Ember.Logger.log("controller.refstes.upload:actions:importFlatFile");

    		var _this = this;
			
			members = members.replace(/\r?\n|\r/g,"\n");
			
			var membersArray = members.split('\n');
			
			var idArray = membersArray.map(function(refCompId)
			{
				if (refCompId !== "")
				{
					return refCompId;
				}
			});
			
			idArray = $.grep(idArray,function(n){ return(n); });

			var loginController = this.get('controllers.login');
			var user = loginController.user;
			
			this.set("getConceptDataInProgress",true);
			
			var defaultMemberModuleId = $('#newRefsetModuleId').val();

			var conceptsNotFound = []; 
			
	//		while(idArray.length)
	//		idArray.splice(0,10)
			{			
				membersAdapter.findList(user,idArray).then(function(result)
				{
					var membersData2;
					
					if (typeof result.meta.errorInfo === "undefined")
					{
						var conceptData = result.content.concepts;
										
						membersData2 = idArray.map(function(refCompId)
						{
							var member = {};
							
							member.referencedComponentId = refCompId;
							member.moduleId = defaultMemberModuleId;
							member.meta = {};
							
							if (conceptData[refCompId] !== null)
							{
								member.active 						= true;
								member.description					= conceptData[refCompId].label;
								member.meta.conceptActive 			= conceptData[refCompId].active;
								member.meta.deleteConcept 			= !conceptData[refCompId].active;
								member.meta.found 					= true;
								member.meta.disabled				= !conceptData[refCompId].active;
	
								return member;
							}
							else
							{
								conceptsNotFound.push(refCompId);
								
								return null;
							}
						});
						
						membersData2 = $.grep(membersData2,function(n){ return(n); });
						
						if (conceptsNotFound.length)
						{
							BootstrapDialog.show({
					            title: 'Concept SCTIDs not found',
					            type : BootstrapDialog.TYPE_WARNING,
					            closable: false,
					            message: '<br><br><div class="centre">The identifiers listed below are not in SNOMED CT and cannot be imported.</div><br><br><div class="centre">' + conceptsNotFound.toString() + '</div><br><br>',
					            buttons: [{
					                label: 'OK',
					                cssClass: 'btn-primary',
					                action: function(dialogRef){
					                    dialogRef.close();
					                }
					            }]
					        });
						}
						
						_this.set("importError",null);
						_this.model.setObjects(membersData2);
					}
					else
					{
						Ember.Logger.log(result.error);
						_this.set("importError",result.error);
					}
	
					_this.set("getConceptDataInProgress",false);
				});
			}
		},

    }
});